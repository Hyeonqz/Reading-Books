# 12장 - 웹 소켓
웹 소켓은 웹 어플리케이션의 성능과 응답을 개선하기 위해 개발된 고급 네트워크 프로토콜 입니다 <br>

실시간 웹이란 사용자 또는 사용자의 소프트웨어가 주기적으로 업데이트를 확인하지 않고도 저자가 정보를 게시하는 즉시 정보를 받을 수 있는 네트워크 웹 이다 <br>

## 웹소켓 소개
웹 소켓 프로토콜은 웹의 양방향 데이터 전송 프로토콜이고, 메시지 수신을 비동기적으로 처리하게 요구된 프로토콜이다 <br>

네티의 웹소켓 지원에는 현재 이용되고 있는 모든 주요 구현이 포함되므로 손쉽게 다음에 개발할 애플리케이션에 도입할 수 있다 <br>
네티의 다른 기능과 마찬가지로 내부 구현 세부 사항에 대해서는 잘 몰라도 프로토콜을 완전히 이용할 수 있다 <br>

### 웹소켓 어플리케이션
페이스북의 텍스트 메시징 기능과 비슷하게 브라우저 기반 채팅 어플리케이션을 구현하면서 웹소켓 프로토콜의 실시간 기능에 대해 알아보자 <br>
- 여러 사용자가 동시에 채팅할 수 있다.
- 클라이언트가 메시지를 보낸다.
- 연결된 모든 클라이언트로 메시지가 브로드캐스팅 된다.

위 설명이 보통 채팅방으 작동 방식이다
1) 클라이언트가 서버에 연결하고 채팅에 참여
2) 채팅 메시지가 웹 소켓을 통해 교환
3) 메시지가 양방향으로 전송
4) 서버가 모든 클라이언트를 처리

### 웹소켓 지원 추가
표준 Http 또는 HTTPS 프로토콜에서 웹소켓으로 전환되는 데는 업그레이드 핸드셰이크 라는 메커니즘이 사용된다 <br>
3way handshake 는 TCP 연결에서만 사용되는 연결수립 방법이다 <br>
tcp 위에 http 가 있기 때문에 http 통신에서는 따로 3way handshake 를 수행하지 않는다 <br>

웹소켓을 이용하는 애플리케이션은 항상 http/s 로 시작한 다음 웹소켓으로 업그레이드 한다 <br>
업그레이드 되는 시점은 애플리케이션에 따라 다르다 <br>
즉 애플리케이션이 시작하는 동안 업그레이드 되거나 특정 URL 이 요청될 때 업그레이드 될 수 있다 <br>

아래 예제는 요청된 URL 이 /ws 로 끝나는 경우 웹소켓으로 업그레이드 하며, 그렇지 않으면 기본적인 HTTP/S 를 이용한다 <br>
1) 채팅방 클라이언트
2) 클라이언트가 http 요청(표준 또는 /ws URI)전송
3) 채팅방 서버
4) url 요청의 경우 서버가 index.html 전송
5) url /ws 요청의 경우 서버가 웹 소켓 업그레이드를 수행
6) 업그레이드가 완료된 후 서버가 웹소켓을 통해 메시지를 전송

#### HTTP 요청 처리
이 컴포넌트는 채팅방에 대한 접근을 제공하고 연결된 클라이언트가 보낸 메시지를 표시한다 <br>
```java
public class HttpRequestHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

	private final String wsUri;
	private static final File INDEX;
	
	static {
		URL location = HttpRequestHandler.class
			.getProtectionDomain()
			.getCodeSource().getLocation();
		try {
			String path = location.toURI() + "index.html";
			path = !path.contains("file:") ? path : path.substring(5);
			INDEX = new File(path);
		} catch (URISyntaxException e) {
			throw new IllegalStateException("Unable to locate index.html", e);
		}
	}

	public HttpRequestHandler (String wsUri) {
		this.wsUri = wsUri;
	}

	@Override
	public void channelRead (ChannelHandlerContext ctx, Object msg) throws Exception {
		super.channelRead(ctx, msg);
		// 웹 소켓 업그레이드 로직 및 구현 로직
	}

	@Override
	protected void messageReceived (ChannelHandlerContext ctx, FullHttpRequest msg) throws Exception {
	}

}
```

웹 소켓 프레임: 각 메시지의 일부를 나타내는 프레임으로 데이터를 전송하며, 한 메시지는 여러 프레임으로 구성될 수 있다

#### 웹 소켓 프레임 처리

## UDP
연결기반 전송(TCP) 는 두 네트워크 엔드포인트 간의 연결을 관리하며, 이러한 연결의 수명주기 동안 메시지를 순서대로 안정정으로 보장하며, 마지막에 연결을 종료한다 <br>
비연결 프로토콜(UDP) 는 안정적 연결이라는 개념이 없고, 각 메시지 UDP 데이터그램이 독립적으로 전송된다.<br>

TCP 연결은 양방향의 메시지가 순서대로 전달되는 전화 통화와 비슷하다면 <br>
UDP 는 우체통(데이터 그램)을 통해 여러 장을 엽서를 넣는것과 비슷하다 <br>
우체통에 여러 엽서를 넣으면 어떤 게 먼저 전달될지는 모르는 것이다 <br>

단점이 많아 보이겠지만, 모든 핸드셰이크와 메시지 관리가 배제되므로 속도가 빠르다는 장점이 있다 <br>

### UDP 브로드 캐스트
- 멀티캐스트: 정의된 호스트 그룹으로 전송
- 브로드캐스트: 네트워크 상의 모든 호스트로 전송

### 용어 정리
- 브로드 캐스팅: 신 호스트가 전송한 데이터가 네트워크에 연결된 모든 호스트에 전송되는 방식